format_version: "14"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

title: "Trigger GitLab Job and Update Build Status"
summary: "Fetch pipelines and jobs from GitLab, publish Bitrise build status, and optionally trigger a job."
description: |
  This step:
    - Fetches pipelines and jobs for a merge request from GitLab.
    - Publishes the Bitrise build status to GitLab.
    - Triggers a specified GitLab job if the build status is successful.

inputs:
  - BITRISE_PROJECT_PATH:
      opts:
        title: "GitLab Project Path"
        summary: "The full path of the GitLab project (e.g., 'group/project')."
        is_required: true
        description: "Specify the full path of the GitLab project."
  - BITRISE_MERGE_REQUEST_IID:
      opts:
        title: "Merge Request IID"
        summary: "The IID of the GitLab merge request."
        is_required: true
        description: "Specify the IID of the merge request."
  - GITLAB_JOB_NAME:
      opts:
        title: "GitLab Job Name"
        summary: "The name of the GitLab job to trigger (e.g., 'test-job')."
        is_required: true
        description: "Specify the name of the job to trigger within the pipeline."
  - BITRISE_BUILD_STATUS:
      opts:
        title: "Bitrise Build Status"
        summary: "The status of the Bitrise build to publish to GitLab."
        is_required: true
        description: |
          Specify the Bitrise build status:
            - 0: Successful
            - 1: Failed
  - BITRISE_GIT_COMMIT:
      opts:
        title: "Git Commit SHA"
        summary: "The Git commit SHA to associate with the status update."
        is_required: true
        description: "Specify the SHA of the commit to associate with the status update."
  - BITRISE_BUILD_URL:
      opts:
        title: "Bitrise Build URL"
        summary: "Optional URL for the Bitrise build."
        is_required: false
        description: "Provide the URL of the Bitrise build for reference in GitLab."
  - GITLAB_TOKEN:
      opts:
        title: "GitLab Personal Access Token"
        summary: "Personal access token to authenticate with GitLab."
        is_required: true
        description: |
          Specify a GitLab personal access token with API scope for authenticating requests.

outputs: []

steps:
  - script:
      title: "Trigger GitLab Job and Update Build Status"
      script:
        content: |
          #!/bin/bash
          go run ./trigger_gitlab_job.go

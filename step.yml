format_version: "0.0.6"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

step:
  title: "Trigger GitLab Job and Update Build Status"
  summary: "Fetch pipelines and jobs from GitLab, publish Bitrise build status, and optionally trigger a job."
  description: |
    This step:
      - Fetches pipelines and jobs for a merge request from GitLab.
      - Publishes the Bitrise build status to GitLab.
      - Triggers a specified GitLab job if the build status is successful.

  inputs:
    - BITRISE_PROJECT_PATH:
        opts:
          is_required: true
          description: "The full path of the GitLab project (e.g., 'group/project')."
    - BITRISE_MERGE_REQUEST_IID:
        opts:
          is_required: true
          description: "The IID of the GitLab merge request."
    - BITRISE_JOB_NAME:
        opts:
          is_required: true
          description: "The name of the GitLab job to trigger (e.g., 'test-job')."
    - BITRISE_BUILD_STATUS:
        opts:
          is_required: true
          description: |
            The Bitrise build status to publish to GitLab:
              - 0: Success
              - 1: Failed
    - BITRISE_GIT_COMMIT:
        opts:
          is_required: true
          description: "The Git commit SHA to associate with the status update."
    - BITRISE_BUILD_URL:
        opts:
          is_required: false
          description: "The Bitrise build URL to include in the status update."
    - GITLAB_TOKEN:
        opts:
          is_required: true
          description: "A personal access token for authenticating with GitLab."
  
  outputs: []

  steps:
    - script:
        title: "Trigger GitLab Job and Update Build Status"
        script:
          content: |
            #!/bin/bash
            go run ./trigger_gitlab_job.go
